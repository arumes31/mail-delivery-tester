{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-12 mb-4">
        <h2><i class="fa-solid fa-users-gear me-2"></i>Manage Recipients</h2>
        <p class="text-muted">Configure target email addresses and their individual monitoring schedules.</p>
    </div>
</div>

<div class="card mb-4 shadow-sm border-0">
    <div class="card-header bg-light fw-bold text-uppercase small text-muted">
        <i class="fa-solid fa-plus me-1"></i> Add New Recipient
    </div>
    <div class="card-body">
        <form id="add-form" class="row g-3">
            <div class="col-md-4">
                <label for="emailInput" class="form-label fw-bold">Email Address</label>
                <div class="input-group">
                    <span class="input-group-text"><i class="fa-solid fa-envelope"></i></span>
                    <input type="email" class="form-control" id="emailInput" placeholder="recipient@example.com" required>
                </div>
            </div>
            <div class="col-md-2">
                <label for="intervalInput" class="form-label fw-bold">Interval</label>
                <div class="input-group">
                    <input type="number" class="form-control" id="intervalInput" value="3600" min="30" required>
                    <span class="input-group-text">sec</span>
                </div>
                <div class="form-text">Time between probes</div>
            </div>
            <div class="col-md-2">
                <label for="thresholdInput" class="form-label fw-bold">Threshold</label>
                <div class="input-group">
                    <input type="number" class="form-control" id="thresholdInput" value="300" min="10" required>
                    <span class="input-group-text">sec</span>
                </div>
                <div class="form-text">Alert after delay</div>
            </div>
             <div class="col-md-2">
                <label class="form-label fw-bold d-block">Alert Channels</label>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="emailAlertsInput" checked>
                    <label class="form-check-label" for="emailAlertsInput"><i class="fa-solid fa-envelope me-1"></i> Email</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="discordAlertsInput" checked>
                    <label class="form-check-label" for="discordAlertsInput"><i class="fa-brands fa-discord me-1"></i> Discord</label>
                </div>
            </div>
            <div class="col-md-2 d-flex align-items-center pt-3">
                <button type="submit" class="btn btn-primary w-100">
                    <i class="fa-solid fa-plus me-1"></i> Add
                </button>
            </div>
        </form>
    </div>
</div>

<div class="card shadow-sm border-0">
    <div class="card-header bg-light fw-bold text-uppercase small text-muted">
        <i class="fa-solid fa-list me-1"></i> Active Recipients
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0 align-middle table-middle">
                <thead class="table-light">
                    <tr>
                        <th>Email</th>
                        <th style="width: 120px;">Interval (s)</th>
                        <th style="width: 120px;">Threshold (s)</th>
                        <th class="text-center">Active</th>
                        <th class="text-center">Email</th>
                        <th class="text-center">Discord</th>
                        <th class="text-end">Actions</th>
                    </tr>
                </thead>
                <tbody id="recipients-list">
                    <!-- Data here -->
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function loadRecipients() {
        fetch('/api/recipients')
            .then(res => res.json())
            .then(data => {
                const tbody = document.getElementById('recipients-list');
                tbody.innerHTML = '';
                if (data.length === 0) {
                     tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-muted">No recipients configured. Add one above.</td></tr>';
                     return;
                }
                data.forEach(r => {
                    tbody.innerHTML += `
                        <tr id="row-${r.id}">
                            <td class="fw-bold">${r.email}</td>
                            <td>
                                <input type="number" class="form-control form-control-sm" id="interval-${r.id}" value="${r.send_interval}" min="30">
                            </td>
                            <td>
                                <input type="number" class="form-control form-control-sm" id="threshold-${r.id}" value="${r.alert_threshold}" min="10">
                            </td>
                            <td class="text-center">
                                <div class="form-check form-switch d-flex justify-content-center">
                                    <input class="form-check-input" type="checkbox" id="active-${r.id}" ${r.active ? 'checked' : ''}>
                                </div>
                            </td>
                            <td class="text-center">
                                <div class="form-check form-switch d-flex justify-content-center">
                                    <input class="form-check-input" type="checkbox" id="email-alerts-${r.id}" ${r.email_alerts_enabled ? 'checked' : ''}>
                                </div>
                            </td>
                            <td class="text-center">
                                <div class="form-check form-switch d-flex justify-content-center">
                                    <input class="form-check-input" type="checkbox" id="discord-alerts-${r.id}" ${r.discord_alerts_enabled ? 'checked' : ''}>
                                </div>
                            </td>
                            <td class="text-end">
                                <button class="btn btn-sm btn-outline-success me-1" onclick="saveRecipient(${r.id})" title="Save Changes">
                                    <i class="fa-solid fa-save"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteRecipient(${r.id})" title="Delete">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
            });
    }

    document.getElementById('add-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const email = document.getElementById('emailInput').value;
        const interval = document.getElementById('intervalInput').value;
        const threshold = document.getElementById('thresholdInput').value;
        const emailAlerts = document.getElementById('emailAlertsInput').checked;
        const discordAlerts = document.getElementById('discordAlertsInput').checked;
        
        fetch('/api/recipients', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                email: email,
                send_interval: interval,
                alert_threshold: threshold,
                email_alerts_enabled: emailAlerts,
                discord_alerts_enabled: discordAlerts
            })
        }).then(res => {
            if (res.ok) {
                document.getElementById('emailInput').value = '';
                showToast('Recipient added successfully.', 'Success');
                loadRecipients();
            } else {
                res.json().then(d => showToast(d.error, 'Error'));
            }
        });
    });

    function saveRecipient(id) {
        const interval = document.getElementById(`interval-${id}`).value;
        const threshold = document.getElementById(`threshold-${id}`).value;
        const active = document.getElementById(`active-${id}`).checked;
        const emailAlerts = document.getElementById(`email-alerts-${id}`).checked;
        const discordAlerts = document.getElementById(`discord-alerts-${id}`).checked;

        fetch(`/api/recipients/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                send_interval: interval,
                alert_threshold: threshold,
                active: active,
                email_alerts_enabled: emailAlerts,
                discord_alerts_enabled: discordAlerts
            })
        }).then(res => {
            if(res.ok) {
                showToast('Recipient settings updated.', 'Saved');
                loadRecipients();
            } else {
                showToast('Failed to update recipient.', 'Error');
            }
        });
    }

    function deleteRecipient(id) {
        if (!confirm('Are you sure you want to delete this recipient?')) return;
        fetch('/api/recipients/' + id, { method: 'DELETE' })
            .then(res => {
                if(res.ok) {
                    showToast('Recipient deleted.', 'Deleted');
                    loadRecipients();
                } else {
                    showToast('Failed to delete.', 'Error');
                }
            });
    }

    loadRecipients();
</script>
{% endblock %}