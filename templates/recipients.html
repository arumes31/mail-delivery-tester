{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-12 mb-4 d-flex justify-content-between align-items-center">
        <div>
            <h2>
                <i class="fa-solid fa-users-gear me-2"></i>Manage Recipients
                <span id="schedulerStatusBadge" class="badge rounded-pill bg-secondary fs-6 ms-2" style="vertical-align: middle;">
                    <i class="fa-solid fa-spinner fa-spin me-1"></i> Checking Scheduler...
                </span>
            </h2>
            <p class="text-muted mb-0">Configure target email addresses and their individual monitoring schedules.</p>
        </div>
        <div class="d-flex gap-2">
            <button type="button" class="btn btn-outline-secondary" onclick="openCompanySearch('header')" title="Query ConnectWise Company IDs">
                <i class="fa-solid fa-building-magnifying-glass me-1"></i> Search CW Company
            </button>
            <a href="/settings" class="btn btn-outline-info">
                <i class="fa-solid fa-gears me-1"></i> System Settings
            </a>
            <a href="/system-diagnostics" class="btn btn-outline-primary">
                <i class="fa-solid fa-stethoscope me-1"></i> System Diagnostics
            </a>
        </div>
    </div>
</div>

<div class="alert alert-info border-primary bg-opacity-10 mb-4">
    <div class="d-flex">
        <div class="me-3"><i class="fa-solid fa-circle-info fa-2x"></i></div>
        <div>
            <h5 class="alert-heading fw-bold">How it works</h5>
            <p class="mb-0 text-muted">For monitoring to function, each recipient address must be configured to <strong>automatically forward</strong> all incoming mail (or specifically mail with the subject prefix <code>MAILDT-PROBE:</code>) to your monitoring mailbox: <code class="text-primary fw-bold">{{ imap_user }}</code>.</p>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content shadow-lg border-primary">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteModalLabel">Confirm Deletion</h5>
                <button type="button" class="btn-close btn-close-white shadow-none" data-bs-dismiss="modal" aria-label="Close" style="filter: hue-rotate(240deg) brightness(1.5);"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the recipient <strong id="deleteEmailDisplay"></strong>?</p>
                <p class="text-danger small"><i class="fa-solid fa-triangle-exclamation me-1"></i> This will also permanently delete all delivery history for this recipient.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete Permanently</button>
            </div>
        </div>
    </div>
</div>

<!-- ConnectWise Company Search Modal -->
<div class="modal fade" id="companySearchModal" tabindex="-1" aria-labelledby="companySearchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content shadow-lg border-info">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="companySearchModalLabel"><i class="fa-solid fa-building me-2"></i>Search ConnectWise Company</h5>
                <button type="button" class="btn-close btn-close-white shadow-none" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="input-group mb-3">
                    <input type="text" id="companySearchInput" class="form-control" placeholder="Search by name or identifier..." aria-label="Search company">
                    <button class="btn btn-primary" type="button" id="btnRunCompanySearch"><i class="fa-solid fa-magnifying-glass me-1"></i> Search</button>
                </div>
                <div class="table-responsive" style="max-height: 400px;">
                    <table class="table table-sm table-hover align-middle">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Identifier</th>
                                <th class="text-end">Action</th>
                            </tr>
                        </thead>
                        <tbody id="companySearchResults">
                            <tr><td colspan="4" class="text-center py-4 text-muted">Enter search term and click Search</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card mb-4 shadow-sm border-0">
    <div class="card-header bg-light fw-bold text-uppercase small text-muted">
        <i class="fa-solid fa-plus me-1"></i> Add New Recipient
    </div>
    <div class="card-body">
        <form id="add-form" class="row g-3">
            <div class="col-md-3">
                <label for="emailInput" class="form-label fw-bold">Email Address</label>
                <div class="input-group">
                    <span class="input-group-text"><i class="fa-solid fa-envelope"></i></span>
                    <input type="email" class="form-control" id="emailInput" placeholder="recipient@example.com" required>
                </div>
            </div>
            <div class="col-md-2">
                <label for="intervalInput" class="form-label fw-bold">Interval</label>
                <div class="input-group">
                    <input type="number" class="form-control" id="intervalInput" value="3600" min="30" required>
                    <span class="input-group-text">sec</span>
                </div>
            </div>
            <div class="col-md-2">
                <label for="thresholdInput" class="form-label fw-bold">Threshold</label>
                <div class="input-group">
                    <input type="number" class="form-control" id="thresholdInput" value="300" min="10" required>
                    <span class="input-group-text">sec</span>
                </div>
            </div>
             <div class="col-md-4">
                <label class="form-label fw-bold d-block">Alert Channels</label>
                <div class="d-flex align-items-center gap-3 pt-1">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="emailAlertsInput" checked>
                        <label class="form-check-label" for="emailAlertsInput"><i class="fa-solid fa-envelope me-1"></i> Email</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="discordAlertsInput">
                        <label class="form-check-label" for="discordAlertsInput"><i class="fa-solid fa-brands fa-discord me-1"></i> Discord</label>
                    </div>
                    <div class="d-flex align-items-center gap-2">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="cwAlertsInput" onchange="toggleCWDisplay('add')">
                            <label class="form-check-label" for="cwAlertsInput"><i class="fa-solid fa-ticket me-1"></i> Connectwise</label>
                        </div>
                        <div id="cwCompanyIdContainer" style="visibility: hidden;" class="d-flex gap-1">
                            <div class="input-group input-group-sm" style="width: 130px;">
                                <input type="number" class="form-control" id="cwCompanyIdInput" value="250" placeholder="Co. ID" title="Company ID">
                                <button class="btn btn-outline-secondary" type="button" onclick="openCompanySearch('add')" title="Search Company"><i class="fa-solid fa-magnifying-glass"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- CW Auth Options -->
                <div id="cwAuthOptionsContainer" class="d-flex gap-3 mt-2 ps-3 border-start border-3 border-info" style="display: none !important;">
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id="cwSpfAlertInput" checked>
                        <label class="form-check-label small" for="cwSpfAlertInput">SPF Alert</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id="cwDkimAlertInput" checked>
                        <label class="form-check-label small" for="cwDkimAlertInput">DKIM Alert</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id="cwDmarcAlertInput" checked>
                        <label class="form-check-label small" for="cwDmarcAlertInput">DMARC Alert</label>
                    </div>
                </div>
            </div>
            <div class="col-md-1 d-flex align-items-center pt-3">
                <button type="submit" class="btn btn-primary w-100">
                    <i class="fa-solid fa-plus"></i>
                </button>
            </div>
        </form>
    </div>
</div>

<div class="card shadow-sm border-0">
    <div class="card-header bg-light fw-bold text-uppercase small text-muted">
        <i class="fa-solid fa-list me-1"></i> Active Recipients
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0 align-middle table-middle">
                <thead class="table-light">
                    <tr>
                        <th>Email</th>
                        <th style="width: 100px;">Interval (s)</th>
                        <th style="width: 100px;">Threshold (s)</th>
                        <th class="text-center">Active</th>
                        <th class="text-center">Email</th>
                        <th class="text-center">Discord</th>
                        <th class="text-center" style="width: 280px;">Connectwise Ticketing</th>
                        <th class="text-end">Actions</th>
                    </tr>
                </thead>
                <tbody id="recipients-list">
                    <!-- Data here -->
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function toggleCWDisplay(id) {
        if (id === 'add') {
            const checked = document.getElementById('cwAlertsInput').checked;
            document.getElementById('cwCompanyIdContainer').style.visibility = checked ? 'visible' : 'hidden';
            const authOpts = document.getElementById('cwAuthOptionsContainer');
            if(checked) {
                authOpts.style.setProperty('display', 'flex', 'important');
                // Ensure they are checked when enabling
                document.getElementById('cwSpfAlertInput').checked = true;
                document.getElementById('cwDkimAlertInput').checked = true;
                document.getElementById('cwDmarcAlertInput').checked = true;
            } else {
                authOpts.style.setProperty('display', 'none', 'important');
            }
        } else {
            const checked = document.getElementById(`cw-alerts-${id}`).checked;
            document.getElementById(`cw-company-container-${id}`).style.visibility = checked ? 'visible' : 'hidden';
            const authOpts = document.getElementById(`cw-auth-options-${id}`);
            if(checked) {
                authOpts.style.setProperty('display', 'flex', 'important');
            } else {
                authOpts.style.setProperty('display', 'none', 'important');
            }
        }
    }

    function updateSchedulerStatus() {
        const badge = document.getElementById('schedulerStatusBadge');
        fetch('/api/scheduler/health')
            .then(res => res.json())
            .then(data => {
                if (data.status === 'scheduler running') {
                    badge.className = 'badge rounded-pill bg-success fs-6 ms-2';
                    badge.innerHTML = '<i class="fa-solid fa-check-circle me-1"></i> Scheduler Active';
                } else {
                    badge.className = 'badge rounded-pill bg-danger fs-6 ms-2';
                    badge.innerHTML = '<i class="fa-solid fa-circle-exclamation me-1"></i> Scheduler Error';
                }
            })
            .catch(err => {
                badge.className = 'badge rounded-pill bg-danger fs-6 ms-2';
                badge.innerHTML = '<i class="fa-solid fa-circle-xmark me-1"></i> Scheduler Offline';
            });
    }

    function loadRecipients() {
        fetch('/api/recipients')
            .then(res => res.json())
            .then(data => {
                const tbody = document.getElementById('recipients-list');
                tbody.innerHTML = '';
                if (data.length === 0) {
                     tbody.innerHTML = '<tr><td colspan="8" class="text-center py-4 text-muted">No recipients configured. Add one above.</td></tr>';
                     return;
                }
                data.forEach(r => {
                    tbody.innerHTML += `
                        <tr id="row-${r.id}">
                            <td class="fw-bold">${r.email}</td>
                            <td>
                                <input type="number" class="form-control form-control-sm" id="interval-${r.id}" value="${r.send_interval}" min="30">
                            </td>
                            <td>
                                <input type="number" class="form-control form-control-sm" id="threshold-${r.id}" value="${r.alert_threshold}" min="10">
                            </td>
                            <td class="text-center">
                                <div class="form-check form-switch d-flex justify-content-center">
                                    <input class="form-check-input" type="checkbox" id="active-${r.id}" ${r.active ? 'checked' : ''}>
                                </div>
                            </td>
                            <td class="text-center">
                                <div class="form-check form-switch d-flex justify-content-center">
                                    <input class="form-check-input" type="checkbox" id="email-alerts-${r.id}" ${r.email_alerts_enabled ? 'checked' : ''}>
                                </div>
                            </td>
                            <td class="text-center">
                                <div class="form-check form-switch d-flex justify-content-center">
                                    <input class="form-check-input" type="checkbox" id="discord-alerts-${r.id}" ${r.discord_alerts_enabled ? 'checked' : ''}>
                                </div>
                            </td>
                            <td>
                                <div class="d-flex flex-column align-items-center">
                                    <div class="d-flex align-items-center justify-content-center gap-2 mb-1">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="cw-alerts-${r.id}" ${r.cw_alerts_enabled ? 'checked' : ''} onchange="toggleCWDisplay(${r.id})">
                                        </div>
                                        <div id="cw-company-container-${r.id}" style="width: 120px; visibility: ${r.cw_alerts_enabled ? 'visible' : 'hidden'}">
                                            <div class="input-group input-group-sm">
                                                <input type="number" class="form-control" id="cw-company-${r.id}" value="${r.cw_company_id || 250}">
                                                <button class="btn btn-outline-secondary" type="button" onclick="openCompanySearch(${r.id})" title="Search"><i class="fa-solid fa-magnifying-glass"></i></button>
                                            </div>
                                        </div>
                                    </div>
                                    <div id="cw-auth-options-${r.id}" class="d-flex gap-2 small text-muted" style="${r.cw_alerts_enabled ? 'display: flex !important;' : 'display: none !important;'}">
                                        <div class="form-check p-0 m-0" title="SPF Alert">
                                            <input class="form-check-input m-0" type="checkbox" id="cw-spf-${r.id}" ${r.cw_spf_alert ? 'checked' : ''}> <span style="font-size: 0.75rem;">SPF</span>
                                        </div>
                                        <div class="form-check p-0 m-0" title="DKIM Alert">
                                            <input class="form-check-input m-0" type="checkbox" id="cw-dkim-${r.id}" ${r.cw_dkim_alert ? 'checked' : ''}> <span style="font-size: 0.75rem;">DKIM</span>
                                        </div>
                                        <div class="form-check p-0 m-0" title="DMARC Alert">
                                            <input class="form-check-input m-0" type="checkbox" id="cw-dmarc-${r.id}" ${r.cw_dmarc_alert ? 'checked' : ''}> <span style="font-size: 0.75rem;">DMARC</span>
                                        </div>
                                    </div>
                                </div>
                            </td>
                            <td class="text-end">
                                <button class="btn btn-sm btn-outline-success me-1" onclick="saveRecipient(${r.id})" title="Save Changes">
                                    <i class="fa-solid fa-save"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="confirmDelete(${r.id}, '${r.email}')" title="Delete">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
                // Initialize add form visibility
                toggleCWDisplay('add');
            });
    }

    let recipientIdToDelete = null;
    const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));

    function confirmDelete(id, email) {
        recipientIdToDelete = id;
        document.getElementById('deleteEmailDisplay').innerText = email;
        deleteModal.show();
    }

    document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
        if (!recipientIdToDelete) return;
        
        fetch('/api/recipients/' + recipientIdToDelete, { method: 'DELETE' })
            .then(res => {
                deleteModal.hide();
                if(res.ok) {
                    showToast('Recipient deleted.', 'Deleted');
                    loadRecipients();
                } else {
                    showToast('Failed to delete.', 'Error');
                }
            });
    });

    document.getElementById('add-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const email = document.getElementById('emailInput').value;
        const interval = document.getElementById('intervalInput').value;
        const threshold = document.getElementById('thresholdInput').value;
        const companyId = document.getElementById('cwCompanyIdInput').value;
        const emailAlerts = document.getElementById('emailAlertsInput').checked;
        const discordAlerts = document.getElementById('discordAlertsInput').checked;
        const cwAlerts = document.getElementById('cwAlertsInput').checked;
        
        const cwSpf = document.getElementById('cwSpfAlertInput').checked;
        const cwDkim = document.getElementById('cwDkimAlertInput').checked;
        const cwDmarc = document.getElementById('cwDmarcAlertInput').checked;

        fetch('/api/recipients', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                email: email,
                send_interval: interval,
                alert_threshold: threshold,
                cw_company_id: companyId,
                email_alerts_enabled: emailAlerts,
                discord_alerts_enabled: discordAlerts,
                cw_alerts_enabled: cwAlerts,
                cw_spf_alert: cwSpf,
                cw_dkim_alert: cwDkim,
                cw_dmarc_alert: cwDmarc
            })
        }).then(res => {
            if (res.ok) {
                document.getElementById('emailInput').value = '';
                // Reset CW checkboxes to checked
                document.getElementById('cwSpfAlertInput').checked = true;
                document.getElementById('cwDkimAlertInput').checked = true;
                document.getElementById('cwDmarcAlertInput').checked = true;
                
                showToast('Recipient added successfully.', 'Success');
                loadRecipients();
            } else {
                res.json().then(d => showToast(d.error, 'Error'));
            }
        });
    });

    function saveRecipient(id) {
        const interval = document.getElementById(`interval-${id}`).value;
        const threshold = document.getElementById(`threshold-${id}`).value;
        const companyId = document.getElementById(`cw-company-${id}`).value;
        const active = document.getElementById(`active-${id}`).checked;
        const emailAlerts = document.getElementById(`email-alerts-${id}`).checked;
        const discordAlerts = document.getElementById(`discord-alerts-${id}`).checked;
        const cwAlerts = document.getElementById(`cw-alerts-${id}`).checked;
        
        const cwSpf = document.getElementById(`cw-spf-${id}`).checked;
        const cwDkim = document.getElementById(`cw-dkim-${id}`).checked;
        const cwDmarc = document.getElementById(`cw-dmarc-${id}`).checked;

        fetch(`/api/recipients/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                send_interval: interval,
                alert_threshold: threshold,
                cw_company_id: companyId,
                active: active,
                email_alerts_enabled: emailAlerts,
                discord_alerts_enabled: discordAlerts,
                cw_alerts_enabled: cwAlerts,
                cw_spf_alert: cwSpf,
                cw_dkim_alert: cwDkim,
                cw_dmarc_alert: cwDmarc
            })
        }).then(res => {
            if(res.ok) {
                showToast('Recipient settings updated.', 'Saved');
                loadRecipients();
            } else {
                showToast('Failed to update recipient.', 'Error');
            }
        });
    }

    // ConnectWise Company Search Logic
    let currentSearchTarget = null;
    const companySearchModal = new bootstrap.Modal(document.getElementById('companySearchModal'));

    function openCompanySearch(target) {
        currentSearchTarget = target;
        document.getElementById('companySearchInput').value = '';
        document.getElementById('companySearchResults').innerHTML = '<tr><td colspan="4" class="text-center py-4 text-muted">Enter search term and click Search</td></tr>';
        companySearchModal.show();
        // Focus input after modal shown
        setTimeout(() => document.getElementById('companySearchInput').focus(), 500);
    }

    document.getElementById('btnRunCompanySearch').addEventListener('click', function() {
        const term = document.getElementById('companySearchInput').value;
        if (!term) return;

        const tbody = document.getElementById('companySearchResults');
        tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4"><i class="fa-solid fa-spinner fa-spin"></i> Searching...</td></tr>';

        fetch(`/api/cw/companies?search=${encodeURIComponent(term)}`)
            .then(res => {
                if (!res.ok) throw new Error('Search failed');
                return res.json();
            })
            .then(data => {
                tbody.innerHTML = '';
                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-muted">No companies found.</td></tr>';
                    return;
                }
                
                if (data.error) {
                     tbody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-danger">${data.error}</td></tr>`;
                     return;
                }

                data.forEach(c => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${c.id}</td>
                        <td class="fw-bold">${c.name}</td>
                        <td>${c.identifier}</td>
                        <td class="text-end">
                            <button class="btn btn-sm btn-primary" onclick="selectCompany(${c.id})">
                                <i class="fa-solid fa-check"></i> Select
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            })
            .catch(err => {
                tbody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-danger">Error: ${err.message}</td></tr>`;
            });
    });
    
    // Enable enter key for search
    document.getElementById('companySearchInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            document.getElementById('btnRunCompanySearch').click();
        }
    });

    function selectCompany(id) {
        if (currentSearchTarget === 'add') {
            document.getElementById('cwCompanyIdInput').value = id;
        } else {
            document.getElementById(`cw-company-${currentSearchTarget}`).value = id;
        }
        companySearchModal.hide();
    }

    loadRecipients();
    updateSchedulerStatus();
    setInterval(updateSchedulerStatus, 30000);
</script>
{% endblock %}