{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-12 mb-4 d-flex justify-content-between align-items-center">
        <div>
            <h2><i class="fa-solid fa-users-gear me-2"></i>Manage Recipients</h2>
            <p class="text-muted mb-0">Configure target email addresses and their individual monitoring schedules.</p>
        </div>
        <div class="d-flex gap-2">
            <a href="/settings" class="btn btn-outline-info">
                <i class="fa-solid fa-gears me-1"></i> System Settings
            </a>
            <a href="/system-diagnostics" class="btn btn-outline-primary">
                <i class="fa-solid fa-stethoscope me-1"></i> System Diagnostics
            </a>
        </div>
    </div>
</div>

<div class="alert alert-info border-primary bg-opacity-10 mb-4">
    <div class="d-flex">
        <div class="me-3"><i class="fa-solid fa-circle-info fa-2x"></i></div>
        <div>
            <h5 class="alert-heading fw-bold">How it works</h5>
            <p class="mb-0 text-muted">For monitoring to function, each recipient address must be configured to <strong>automatically forward</strong> all incoming mail (or specifically mail with the subject prefix <code>MAILDT-PROBE:</code>) to your monitoring mailbox: <code class="text-primary fw-bold">{{ imap_user }}</code>.</p>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content shadow-lg border-primary">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteModalLabel">Confirm Deletion</h5>
                <button type="button" class="btn-close btn-close-white shadow-none" data-bs-dismiss="modal" aria-label="Close" style="filter: hue-rotate(240deg) brightness(1.5);"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the recipient <strong id="deleteEmailDisplay"></strong>?</p>
                <p class="text-danger small"><i class="fa-solid fa-triangle-exclamation me-1"></i> This will also permanently delete all delivery history for this recipient.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete Permanently</button>
            </div>
        </div>
    </div>
</div>

<div class="card mb-4 shadow-sm border-0">
    <div class="card-header bg-light fw-bold text-uppercase small text-muted">
        <i class="fa-solid fa-plus me-1"></i> Add New Recipient
    </div>
    <div class="card-body">
        <form id="add-form" class="row g-3">
            <div class="col-md-4">
                <label for="emailInput" class="form-label fw-bold">Email Address</label>
                <div class="input-group">
                    <span class="input-group-text"><i class="fa-solid fa-envelope"></i></span>
                    <input type="email" class="form-control" id="emailInput" placeholder="recipient@example.com" required>
                </div>
            </div>
            <div class="col-md-2">
                <label for="intervalInput" class="form-label fw-bold">Interval</label>
                <div class="input-group">
                    <input type="number" class="form-control" id="intervalInput" value="3600" min="30" required>
                    <span class="input-group-text">sec</span>
                </div>
                <div class="form-text">Time between probes</div>
            </div>
            <div class="col-md-2">
                <label for="thresholdInput" class="form-label fw-bold">Threshold</label>
                <div class="input-group">
                    <input type="number" class="form-control" id="thresholdInput" value="300" min="10" required>
                    <span class="input-group-text">sec</span>
                </div>
                <div class="form-text">Alert after delay</div>
            </div>
             <div class="col-md-2">
                <label class="form-label fw-bold d-block">Alert Channels</label>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="emailAlertsInput" checked>
                    <label class="form-check-label" for="emailAlertsInput"><i class="fa-solid fa-envelope me-1"></i> Email</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="discordAlertsInput">
                    <label class="form-check-label" for="discordAlertsInput"><i class="fa-solid fa-brands fa-discord me-1"></i> Discord</label>
                </div>
            </div>
            <div class="col-md-2 d-flex align-items-center pt-3">
                <button type="submit" class="btn btn-primary w-100">
                    <i class="fa-solid fa-plus me-1"></i> Add
                </button>
            </div>
        </form>
    </div>
</div>

<div class="card shadow-sm border-0">
    <div class="card-header bg-light fw-bold text-uppercase small text-muted">
        <i class="fa-solid fa-list me-1"></i> Active Recipients
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0 align-middle table-middle">
                <thead class="table-light">
                    <tr>
                        <th>Email</th>
                        <th style="width: 120px;">Interval (s)</th>
                        <th style="width: 120px;">Threshold (s)</th>
                        <th class="text-center">Active</th>
                        <th class="text-center">Email</th>
                        <th class="text-center">Discord</th>
                        <th class="text-end">Actions</th>
                    </tr>
                </thead>
                <tbody id="recipients-list">
                    <!-- Data here -->
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function loadRecipients() {
        fetch('/api/recipients')
            .then(res => res.json())
            .then(data => {
                const tbody = document.getElementById('recipients-list');
                tbody.innerHTML = '';
                if (data.length === 0) {
                     tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-muted">No recipients configured. Add one above.</td></tr>';
                     return;
                }
                data.forEach(r => {
                    tbody.innerHTML += `
                        <tr id="row-${r.id}">
                            <td class="fw-bold">${r.email}</td>
                            <td>
                                <input type="number" class="form-control form-control-sm" id="interval-${r.id}" value="${r.send_interval}" min="30">
                            </td>
                            <td>
                                <input type="number" class="form-control form-control-sm" id="threshold-${r.id}" value="${r.alert_threshold}" min="10">
                            </td>
                            <td class="text-center">
                                <div class="form-check form-switch d-flex justify-content-center">
                                    <input class="form-check-input" type="checkbox" id="active-${r.id}" ${r.active ? 'checked' : ''}>
                                </div>
                            </td>
                            <td class="text-center">
                                <div class="form-check form-switch d-flex justify-content-center">
                                    <input class="form-check-input" type="checkbox" id="email-alerts-${r.id}" ${r.email_alerts_enabled ? 'checked' : ''}>
                                </div>
                            </td>
                            <td class="text-center">
                                <div class="form-check form-switch d-flex justify-content-center">
                                    <input class="form-check-input" type="checkbox" id="discord-alerts-${r.id}" ${r.discord_alerts_enabled ? 'checked' : ''}>
                                </div>
                            </td>
                            <td class="text-end">
                                <button class="btn btn-sm btn-outline-success me-1" onclick="saveRecipient(${r.id})" title="Save Changes">
                                    <i class="fa-solid fa-save"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="confirmDelete(${r.id}, '${r.email}')" title="Delete">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
            });
    }

    let recipientIdToDelete = null;
    const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));

    function confirmDelete(id, email) {
        recipientIdToDelete = id;
        document.getElementById('deleteEmailDisplay').innerText = email;
        deleteModal.show();
    }

    document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
        if (!recipientIdToDelete) return;
        
        fetch('/api/recipients/' + recipientIdToDelete, { method: 'DELETE' })
            .then(res => {
                deleteModal.hide();
                if(res.ok) {
                    showToast('Recipient deleted.', 'Deleted');
                    loadRecipients();
                } else {
                    showToast('Failed to delete.', 'Error');
                }
            });
    });

    document.getElementById('add-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const email = document.getElementById('emailInput').value;
        const interval = document.getElementById('intervalInput').value;
        const threshold = document.getElementById('thresholdInput').value;
        const emailAlerts = document.getElementById('emailAlertsInput').checked;
        const discordAlerts = document.getElementById('discordAlertsInput').checked;
        
        fetch('/api/recipients', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                email: email,
                send_interval: interval,
                alert_threshold: threshold,
                email_alerts_enabled: emailAlerts,
                discord_alerts_enabled: discordAlerts
            })
        }).then(res => {
            if (res.ok) {
                document.getElementById('emailInput').value = '';
                showToast('Recipient added successfully.', 'Success');
                loadRecipients();
            } else {
                res.json().then(d => showToast(d.error, 'Error'));
            }
        });
    });

    function saveRecipient(id) {
        const interval = document.getElementById(`interval-${id}`).value;
        const threshold = document.getElementById(`threshold-${id}`).value;
        const active = document.getElementById(`active-${id}`).checked;
        const emailAlerts = document.getElementById(`email-alerts-${id}`).checked;
        const discordAlerts = document.getElementById(`discord-alerts-${id}`).checked;

        fetch(`/api/recipients/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                send_interval: interval,
                alert_threshold: threshold,
                active: active,
                email_alerts_enabled: emailAlerts,
                discord_alerts_enabled: discordAlerts
            })
        }).then(res => {
            if(res.ok) {
                showToast('Recipient settings updated.', 'Saved');
                loadRecipients();
            } else {
                showToast('Failed to update recipient.', 'Error');
            }
        });
    }

    loadRecipients();
</script>
{% endblock %}