{% extends "base.html" %}

{% block content %}
<div id="welcome-header" class="row mb-4 mt-2">
    <div class="col-md-12 text-center">
        <img src="{{ url_for('static', filename='img/logo.svg') }}" alt="Logo" class="mb-3" style="height: 60px; filter: drop-shadow(0 0 15px rgba(138, 43, 226, 0.6));">
        <h1 class="fw-bold text-white display-5">MailDT Hub</h1>
        <p class="text-muted">Unified infrastructure monitoring and diagnostics.</p>
    </div>
</div>

<!-- System Widgets -->
<div class="row row-cols-2 row-cols-md-3 row-cols-lg-4 row-cols-xl-6 g-3 mb-5">
    <!-- Dashboard -->
    <div class="col">
        <a href="/dashboard" class="text-decoration-none h-100 d-block">
            <div class="card h-100 home-widget border-0 shadow-lg text-center p-3">
                <div class="widget-icon mb-2 text-primary"><i class="fa-solid fa-chart-line fa-2x"></i></div>
                <h6 class="text-white fw-bold mb-0">Live Monitor</h6>
            </div>
        </a>
    </div>

    <!-- Mail Tester -->
    <div class="col">
        <a href="/mail-tester" class="text-decoration-none h-100 d-block">
            <div class="card h-100 home-widget border-0 shadow-lg text-center p-3">
                <div class="widget-icon mb-2 text-primary"><i class="fa-solid fa-flask fa-2x"></i></div>
                <h6 class="text-white fw-bold mb-0">Mail Tester</h6>
            </div>
        </a>
    </div>

    <!-- SMTP Diagnostics -->
    <div class="col">
        <a href="/smtp-test" class="text-decoration-none h-100 d-block">
            <div class="card h-100 home-widget border-0 shadow-lg text-center p-3">
                <div class="widget-icon mb-2 text-primary"><i class="fa-solid fa-envelope-circle-check fa-2x"></i></div>
                <h6 class="text-white fw-bold mb-0">SMTP Diag</h6>
            </div>
        </a>
    </div>

    <!-- Blacklist Check -->
    <div class="col">
        <a href="/blacklist-check" class="text-decoration-none h-100 d-block">
            <div class="card h-100 home-widget border-0 shadow-lg text-center p-3">
                <div class="widget-icon mb-2 text-primary"><i class="fa-solid fa-list-check fa-2x"></i></div>
                <h6 class="text-white fw-bold mb-0">Blacklist</h6>
            </div>
        </a>
    </div>

    <!-- Decode Spam -->
    <div class="col">
        <a href="/decode-spam" class="text-decoration-none h-100 d-block">
            <div class="card h-100 home-widget border-0 shadow-lg text-center p-3">
                <div class="widget-icon mb-2 text-primary"><i class="fa-solid fa-code fa-2x"></i></div>
                <h6 class="text-white fw-bold mb-0">Decoder</h6>
            </div>
        </a>
    </div>

    {% if config.ENABLE_WHOIS %}
    <div class="col">
        <a href="/whois" class="text-decoration-none h-100 d-block">
            <div class="card h-100 home-widget border-0 shadow-lg text-center p-3">
                <div class="widget-icon mb-2 text-primary"><i class="fa-solid fa-search fa-2x"></i></div>
                <h6 class="text-white fw-bold mb-0">WHOIS</h6>
            </div>
        </a>
    </div>
    {% endif %}

    {% if config.ENABLE_WEBCHECK %}
    <div class="col">
        <a href="/web-check" class="text-decoration-none h-100 d-block">
            <div class="card h-100 home-widget border-0 shadow-lg text-center p-3">
                <div class="widget-icon mb-2 text-primary"><i class="fa-solid fa-globe fa-2x"></i></div>
                <h6 class="text-white fw-bold mb-0">Web Check</h6>
            </div>
        </a>
    </div>
    {% endif %}

    {% if session.logged_in %}
    <div class="col">
        <a href="/recipients" class="text-decoration-none h-100 d-block">
            <div class="card h-100 home-widget border-0 shadow-lg text-center p-3">
                <div class="widget-icon mb-2 text-info"><i class="fa-solid fa-users fa-2x"></i></div>
                <h6 class="text-white fw-bold mb-0">Recipients</h6>
            </div>
        </a>
    </div>
    {% endif %}
</div>

<!-- Custom Widgets Section -->
<div class="row mb-3">
    <div class="col-md-12 d-flex justify-content-between align-items-center">
        <h5 class="text-white fw-bold opacity-75 mb-0"><i class="fa-solid fa-bookmark me-2 text-primary"></i> Custom Widgets</h5>
        {% if session.logged_in %}
        <button class="btn btn-sm btn-outline-primary" onclick="openAddModal()">
            <i class="fa-solid fa-plus me-1"></i> Add
        </button>
        {% endif %}
    </div>
</div>

<div class="row row-cols-2 row-cols-md-3 row-cols-lg-4 row-cols-xl-6 g-3" id="custom-widgets-list">
    {% for widget in custom_widgets %}
    <div class="col" id="widget-col-{{ widget.id }}">
        <div class="card h-100 home-widget border-0 shadow-lg p-3 position-relative">
            {% if session.logged_in %}
            <div class="position-absolute top-0 end-0 p-1 d-flex">
                <button class="btn btn-link btn-sm text-muted p-0 opacity-50 me-1" onclick="openEditModal({{ widget|tojson }})"><i class="fa-solid fa-edit"></i></button>
                <button class="btn btn-link btn-sm text-muted p-0 opacity-50" onclick="deleteWidget({{ widget.id }})"><i class="fa-solid fa-times"></i></button>
            </div>
            {% endif %}
            <a href="{{ widget.url }}" target="_blank" class="text-decoration-none text-center d-block">
                <div class="widget-icon mb-2 d-flex justify-content-center align-items-center" style="height: 48px;">
                    {% if widget.image_path %}
                        <img src="{{ widget.image_path }}" style="max-height: 40px; max-width: 48px; object-fit: contain;">
                    {% else %}
                        <i class="fa-solid {{ widget.icon }} fa-2x" style="color: {{ widget.color }};"></i>
                    {% endif %}
                </div>
                <h6 class="text-white fw-bold mb-0 text-truncate" title="{{ widget.title }}">{{ widget.title }}</h6>
                {% if widget.is_private %}<div style="font-size: 0.5rem;" class="text-warning text-uppercase fw-bold"><i class="fa-solid fa-lock me-1"></i>Private</div>{% endif %}
            </a>
        </div>
    </div>
    {% endfor %}
</div>

{% if session.logged_in %}
<!-- Add/Edit Widget Modal -->
<div class="modal fade" id="widgetModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content shadow-lg border-primary">
            <div class="modal-header">
                <h5 class="modal-title text-white" id="modalTitle">Add Custom Widget</h5>
                <button type="button" class="btn-close shadow-none" data-bs-dismiss="modal" style="filter: hue-rotate(240deg) brightness(1.5);"></button>
            </div>
            <div class="modal-body">
                <form id="widget-form">
                    <input type="hidden" id="w-id">
                    <div class="mb-3">
                        <label class="form-label small fw-bold">Title</label>
                        <input type="text" class="form-control bg-dark border-secondary text-white" id="w-title" placeholder="My Tool" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small fw-bold">URL</label>
                        <input type="url" class="form-control bg-dark border-secondary text-white" id="w-url" placeholder="https://..." required>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label small fw-bold">Icon Class</label>
                            <input type="text" class="form-control bg-dark border-secondary text-white" id="w-icon" value="fa-link">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label small fw-bold">Color</label>
                            <input type="color" class="form-control form-control-color bg-dark border-secondary w-100" id="w-color" value="#8a2be2">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label small fw-bold">Custom Image Icon (Optional)</label>
                        <input type="file" class="form-control bg-dark border-secondary text-white" id="w-file" accept="image/*">
                    </div>

                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="w-private">
                        <label class="form-check-label text-white small" for="w-private">
                            <i class="fa-solid fa-eye-slash me-1"></i> Private Widget (Only visible when logged in)
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary px-4" id="saveBtn" onclick="saveWidget()">Save Widget</button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<style>
    .home-widget {
        transition: all 0.3s cubic-bezier(.25,.8,.25,1);
        cursor: pointer;
        background: rgba(26, 20, 41, 0.6) !important;
        backdrop-filter: blur(5px);
        border: 1px solid rgba(255,255,255,0.05) !important;
    }
    .home-widget:hover {
        transform: translateY(-5px);
        background: rgba(138, 43, 226, 0.1) !important;
        border-color: rgba(138, 43, 226, 0.3) !important;
        box-shadow: 0 10px 25px rgba(0,0,0,0.5) !important;
    }
    .widget-icon {
        transition: transform 0.3s ease;
    }
    .home-widget:hover .widget-icon {
        transform: scale(1.05);
    }

    #welcome-header {
        transition: all 1s ease-in-out;
        max-height: 300px;
        overflow: hidden;
    }
    #welcome-header.fly-away {
        max-height: 0;
        margin-bottom: 0 !important;
        margin-top: 0 !important;
        opacity: 0;
        transform: translateY(-50px);
        pointer-events: none;
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    // Header Animation
    setTimeout(() => {
        const header = document.getElementById('welcome-header');
        if (header) header.classList.add('fly-away');
    }, 4000);

    {% if session.logged_in %}
    const widgetModal = new bootstrap.Modal(document.getElementById('widgetModal'));

    function openAddModal() {
        document.getElementById('w-id').value = '';
        document.getElementById('w-title').value = '';
        document.getElementById('w-url').value = '';
        document.getElementById('w-icon').value = 'fa-link';
        document.getElementById('w-color').value = '#8a2be2';
        document.getElementById('w-private').checked = false;
        document.getElementById('modalTitle').innerText = 'Add Custom Widget';
        widgetModal.show();
    }

    function openEditModal(widget) {
        document.getElementById('w-id').value = widget.id;
        document.getElementById('w-title').value = widget.title;
        document.getElementById('w-url').value = widget.url;
        document.getElementById('w-icon').value = widget.icon;
        document.getElementById('w-color').value = widget.color;
        document.getElementById('w-private').checked = widget.is_private;
        document.getElementById('modalTitle').innerText = 'Edit Custom Widget';
        widgetModal.show();
    }

    function saveWidget() {
        const id = document.getElementById('w-id').value;
        const form = new FormData();
        form.append('title', document.getElementById('w-title').value);
        form.append('url', document.getElementById('w-url').value);
        form.append('icon', document.getElementById('w-icon').value);
        form.append('color', document.getElementById('w-color').value);
        form.append('is_private', document.getElementById('w-private').checked);
        
        const fileInput = document.getElementById('w-file');
        if (fileInput.files.length > 0) {
            form.append('icon_file', fileInput.files[0]);
        }

        if (!document.getElementById('w-title').value || !document.getElementById('w-url').value) return;

        const url = id ? `/api/widgets/${id}` : '/api/widgets';
        const method = id ? 'PUT' : 'POST';

        fetch(url, {
            method: method,
            body: form
        }).then(res => {
            if (res.ok) {
                location.reload();
            } else {
                showToast('Failed to save widget.', 'Error', 'danger');
            }
        });
    }

    function deleteWidget(id) {
        if (!confirm('Delete this widget?')) return;
        fetch(`/api/widgets/${id}`, { method: 'DELETE' })
            .then(res => {
                if (res.ok) {
                    document.getElementById(`widget-col-${id}`).remove();
                    showToast('Widget deleted.', 'Success');
                }
            });
    }
    {% endif %}
</script>
{% endblock %}
