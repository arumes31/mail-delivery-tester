{% extends "base.html" %}

{% block content %}
<!-- Subtle Welcome Notification -->
<div id="welcome-notification" class="welcome-notification">
    <div class="d-flex align-items-center gap-3">
        <img src="{{ url_for('static', filename='img/logo.svg') }}" alt="Logo" style="height: 32px; filter: drop-shadow(0 0 10px rgba(138, 43, 226, 0.6));">
        <div>
            <h5 class="fw-bold text-white mb-0" style="font-size: 1rem;">MailDT Hub</h5>
            <p class="text-muted mb-0" style="font-size: 0.75rem;">Infrastructure monitoring and diagnostics.</p>
        </div>
    </div>
</div>

<!-- System Widgets -->
<div class="row row-cols-2 row-cols-md-3 row-cols-lg-4 row-cols-xl-6 g-3 mb-5">
    <!-- Mail Tester -->
    <div class="col">
        <a href="/mail-tester" class="text-decoration-none h-100 d-block">
            <div class="card h-100 home-widget border-0 shadow-lg text-center p-3">
                <div class="widget-icon mb-2 text-primary"><i class="fa-solid fa-flask fa-2x"></i></div>
                <div class="text-white fw-bold">Mail Tester</div>
            </div>
        </a>
    </div>

    <!-- SMTP Diagnostics -->
    <div class="col">
        <a href="/smtp-test" class="text-decoration-none h-100 d-block">
            <div class="card h-100 home-widget border-0 shadow-lg text-center p-3">
                <div class="widget-icon mb-2 text-primary"><i class="fa-solid fa-envelope-circle-check fa-2x"></i></div>
                <div class="text-white fw-bold">SMTP Diagnostics</div>
            </div>
        </a>
    </div>

    <!-- Blacklist Check -->
    <div class="col">
        <a href="/blacklist-check" class="text-decoration-none h-100 d-block">
            <div class="card h-100 home-widget border-0 shadow-lg text-center p-3">
                <div class="widget-icon mb-2 text-primary"><i class="fa-solid fa-list-check fa-2x"></i></div>
                <div class="text-white fw-bold">Blacklist</div>
            </div>
        </a>
    </div>

    <!-- Decode Spam -->
    <div class="col">
        <a href="/decode-spam" class="text-decoration-none h-100 d-block">
            <div class="card h-100 home-widget border-0 shadow-lg text-center p-3">
                <div class="widget-icon mb-2 text-primary"><i class="fa-solid fa-code fa-2x"></i></div>
                <div class="text-white fw-bold">Decoder</div>
            </div>
        </a>
    </div>

    {% if config.ENABLE_WHOIS %}
    <div class="col">
        <a href="/whois" class="text-decoration-none h-100 d-block">
            <div class="card h-100 home-widget border-0 shadow-lg text-center p-3">
                <div class="widget-icon mb-2 text-primary"><i class="fa-solid fa-search fa-2x"></i></div>
                <div class="text-white fw-bold">WHOIS</div>
            </div>
        </a>
    </div>
    {% endif %}

    {% if config.ENABLE_WEBCHECK %}
    <div class="col">
        <a href="/web-check" class="text-decoration-none h-100 d-block">
            <div class="card h-100 home-widget border-0 shadow-lg text-center p-3">
                <div class="widget-icon mb-2 text-primary"><i class="fa-solid fa-globe fa-2x"></i></div>
                <div class="text-white fw-bold">Web Check</div>
            </div>
        </a>
    </div>
    {% endif %}

    <div class="col">
        <a href="/dashboard" class="text-decoration-none h-100 d-block">
            <div class="card h-100 home-widget border-0 shadow-lg text-center p-3">
                <div class="widget-icon mb-2 text-primary"><i class="fa-solid fa-chart-line fa-2x"></i></div>
                <div class="text-white fw-bold">Live Monitor</div>
            </div>
        </a>
    </div>

    {% if session.logged_in %}
    <div class="col">
        <a href="/recipients" class="text-decoration-none h-100 d-block">
            <div class="card h-100 home-widget border-0 shadow-lg text-center p-3">
                <div class="widget-icon mb-2 text-info"><i class="fa-solid fa-users fa-2x"></i></div>
                <div class="text-white fw-bold">Recipients</div>
            </div>
        </a>
    </div>
    {% endif %}
</div>

<!-- Pins Section -->
<div class="row mb-2">
    <div class="col-md-12 d-flex justify-content-between align-items-center">
        <h6 class="text-white fw-bold opacity-50 mb-0 text-uppercase letter-spacing-1" style="font-size: 0.75rem;"><i class="fa-solid fa-thumbtack me-2 text-primary"></i> Pins</h6>
        {% if session.logged_in %}
        <button class="btn btn-xs btn-outline-primary py-0" onclick="openAddModal()" style="font-size: 0.7rem;">
            <i class="fa-solid fa-plus me-1"></i> Pin
        </button>
        {% endif %}
    </div>
</div>

<div class="row row-cols-2 row-cols-md-3 row-cols-lg-4 row-cols-xl-6 g-3" id="custom-widgets-list">
    {% for widget in custom_widgets %}
    <div class="col" id="widget-col-{{ widget.id }}" data-id="{{ widget.id }}">
        <div class="card h-100 home-widget border-0 shadow-lg p-3 position-relative" style="background: {{ widget.color }}15 !important; border-top: 2px solid {{ widget.color }} !important;">
            {% if session.logged_in %}
            <div class="position-absolute top-0 end-0 p-1 d-flex" style="z-index: 5;">
                <button class="btn btn-link btn-xs text-muted p-0 opacity-50 me-1" onclick='openEditModal({{ widget|tojson }})'><i class="fa-solid fa-edit" style="font-size: 0.6rem;"></i></button>
                <button class="btn btn-link btn-xs text-muted p-0 opacity-50" onclick="deleteWidget({{ widget.id }})"><i class="fa-solid fa-times" style="font-size: 0.6rem;"></i></button>
            </div>
            {% endif %}
            <a href="{{ widget.url }}" target="_blank" class="text-decoration-none text-center d-block">
                <div class="widget-icon mb-2 d-flex justify-content-center align-items-center" style="height: 48px;">
                    {% if widget.image_path %}
                        <img src="{{ widget.image_path }}" class="rounded-circle border" style="width: 48px; height: 48px; object-fit: cover; border-color: {{ widget.color }} !important;">
                    {% else %}
                        <i class="fa-solid {{ widget.icon }} fa-2x" style="color: {{ widget.color }} !important;"></i>
                    {% endif %}
                </div>
                <div class="text-white fw-bold text-truncate px-1" title="{{ widget.title }}">{{ widget.title }}</div>
                {% if widget.is_private %}<div style="font-size: 0.4rem;" class="text-warning text-uppercase fw-bold"><i class="fa-solid fa-lock me-1"></i>Private</div>{% endif %}
            </a>
        </div>
    </div>
    {% endfor %}
</div>

{% if session.logged_in %}
<!-- Add/Edit Pin Modal -->
<div class="modal fade" id="widgetModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content shadow-lg border-primary">
            <div class="modal-header">
                <h5 class="modal-title text-white" id="modalTitle">Add Pin</h5>
                <button type="button" class="btn-close shadow-none" data-bs-dismiss="modal" style="filter: hue-rotate(240deg) brightness(1.5);"></button>
            </div>
            <div class="modal-body">
                <form id="widget-form">
                    <input type="hidden" id="w-id">
                    <div class="mb-3">
                        <label class="form-label small fw-bold">Title</label>
                        <input type="text" class="form-control bg-dark border-secondary text-white" id="w-title" placeholder="My Tool" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small fw-bold">URL</label>
                        <input type="url" class="form-control bg-dark border-secondary text-white" id="w-url" placeholder="https://..." required>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label small fw-bold">Icon</label>
                            <select class="form-select bg-dark border-secondary text-white" id="w-icon">
                                <option value="fa-link">Link</option>
                                <option value="fa-server">Server</option>
                                <option value="fa-globe">Globe</option>
                                <option value="fa-shield-halved">Shield</option>
                                <option value="fa-envelope">Mail</option>
                                <option value="fa-database">Database</option>
                                <option value="fa-terminal">Terminal</option>
                                <option value="fa-chart-area">Charts</option>
                                <option value="fa-cog">Settings</option>
                                <option value="fa-search">Search</option>
                                <option value="fa-lock">Security</option>
                                <option value="fa-cloud">Cloud</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label small fw-bold">Theme Color</label>
                            <input type="color" class="form-control form-control-color bg-dark border-secondary w-100" id="w-color" value="#8a2be2">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label small fw-bold">Custom Image (Optional)</label>
                        <input type="file" class="form-control bg-dark border-secondary text-white" id="w-file" accept="image/*">
                    </div>

                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="w-private">
                        <label class="form-check-label text-white small" for="w-private">
                            <i class="fa-solid fa-eye-slash me-1"></i> Private (Admins Only)
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary px-4" id="saveBtn" onclick="saveWidget()">Save Pin</button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<style>
    .home-widget {
        transition: all 0.3s cubic-bezier(.25,.8,.25,1);
        cursor: pointer;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.05) !important;
    }
    .home-widget:hover {
        transform: translateY(-3px);
        filter: brightness(1.2);
        box-shadow: 0 8px 20px rgba(0,0,0,0.5) !important;
    }
    .widget-icon {
        transition: transform 0.3s ease;
    }
    .home-widget:hover .widget-icon {
        transform: scale(1.05);
    }

    /* Subtle Welcome Notification Styles */
    .welcome-notification {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%) translateY(-100px);
        background: rgba(26, 20, 41, 0.9);
        border: 1px solid var(--bs-primary);
        padding: 12px 24px;
        border-radius: 50px;
        z-index: 10000;
        backdrop-filter: blur(10px);
        box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        opacity: 0;
        transition: all 0.8s cubic-bezier(0.16, 1, 0.3, 1);
        pointer-events: none;
    }
    .welcome-notification.show {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
    }
    .welcome-notification.hide {
        transform: translateX(-50%) translateY(-100px);
        opacity: 0;
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    // Subtle Fly-in Notification
    document.addEventListener('DOMContentLoaded', () => {
        const notify = document.getElementById('welcome-notification');
        if (notify) {
            // Show after a short delay
            setTimeout(() => {
                notify.classList.add('show');
            }, 500);

            // Hide after a few seconds
            setTimeout(() => {
                notify.classList.remove('show');
                notify.classList.add('hide');
            }, 4000);
        }
    });

    {% if session.logged_in %}
    // Initialize Drag & Drop reordering
    const el = document.getElementById('custom-widgets-list');
    const sortable = Sortable.create(el, {
        animation: 150,
        ghostClass: 'opacity-25',
        onEnd: function() {
            saveOrder();
        }
    });

    function saveOrder() {
        const order = sortable.toArray().map(id => id.replace('widget-col-', ''));
        fetch('/api/widgets/reorder', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ order: order })
        }).then(res => {
            if (!res.ok) showToast('Failed to save order.', 'Error', 'danger');
        });
    }

    const widgetModal = new bootstrap.Modal(document.getElementById('widgetModal'));

    function openAddModal() {
        document.getElementById('w-id').value = '';
        document.getElementById('w-title').value = '';
        document.getElementById('w-url').value = '';
        document.getElementById('w-icon').value = 'fa-link';
        document.getElementById('w-color').value = '#8a2be2';
        document.getElementById('w-private').checked = false;
        document.getElementById('modalTitle').innerText = 'Add Pin';
        widgetModal.show();
    }

    function openEditModal(widget) {
        document.getElementById('w-id').value = widget.id;
        document.getElementById('w-title').value = widget.title;
        document.getElementById('w-url').value = widget.url;
        document.getElementById('w-icon').value = widget.icon;
        document.getElementById('w-color').value = widget.color;
        document.getElementById('w-private').checked = widget.is_private;
        document.getElementById('modalTitle').innerText = 'Edit Pin';
        widgetModal.show();
    }

    function saveWidget() {
        const id = document.getElementById('w-id').value;
        const form = new FormData();
        form.append('title', document.getElementById('w-title').value);
        form.append('url', document.getElementById('w-url').value);
        form.append('icon', document.getElementById('w-icon').value);
        form.append('color', document.getElementById('w-color').value);
        form.append('is_private', document.getElementById('w-private').checked);
        
        const fileInput = document.getElementById('w-file');
        if (fileInput.files.length > 0) {
            form.append('icon_file', fileInput.files[0]);
        }

        if (!document.getElementById('w-title').value || !document.getElementById('w-url').value) return;

        const url = id ? `/api/widgets/${id}` : '/api/widgets';
        const method = 'POST'; 
        
        if (id) {
            form.append('_method', 'PUT');
        }

        fetch(url, {
            method: method,
            body: form
        }).then(res => {
            if (res.ok) {
                location.reload();
            } else {
                showToast('Failed to save Pin.', 'Error', 'danger');
            }
        });
    }

    function deleteWidget(id) {
        if (!confirm('Delete this Pin?')) return;
        fetch(`/api/widgets/${id}`, { method: 'DELETE' })
            .then(res => {
                if (res.ok) {
                    document.getElementById(`widget-col-${id}`).remove();
                    showToast('Pin deleted.', 'Success');
                }
            });
    }
    {% endif %}
</script>
{% endblock %}