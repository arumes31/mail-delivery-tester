{% extends "base.html" %}

{% block content %}
<!-- Welcome Splash Overlay -->
<div id="welcome-overlay" class="welcome-overlay">
    <div class="welcome-content text-center">
        <img src="{{ url_for('static', filename='img/logo.svg') }}" alt="Logo" class="mb-4 splash-logo">
        <h1 class="fw-bold text-white display-2 mb-2">MailDT Hub</h1>
        <p class="text-muted fs-4">Unified infrastructure monitoring and diagnostics.</p>
    </div>
</div>

<!-- System Widgets -->
<div class="row row-cols-2 row-cols-md-4 row-cols-lg-6 row-cols-xl-8 g-2 mb-5">
    <!-- Mail Tester -->
    <div class="col">
        <a href="/mail-tester" class="text-decoration-none h-100 d-block">
            <div class="card h-100 home-widget border-0 shadow-lg text-center p-2">
                <div class="widget-icon mb-1 text-primary"><i class="fa-solid fa-flask fa-xl"></i></div>
                <div class="text-white small fw-bold">Mail Tester</div>
            </div>
        </a>
    </div>

    <!-- SMTP Diagnostics -->
    <div class="col">
        <a href="/smtp-test" class="text-decoration-none h-100 d-block">
            <div class="card h-100 home-widget border-0 shadow-lg text-center p-2">
                <div class="widget-icon mb-1 text-primary"><i class="fa-solid fa-envelope-circle-check fa-xl"></i></div>
                <div class="text-white small fw-bold">SMTP Diag</div>
            </div>
        </a>
    </div>

    <!-- Blacklist Check -->
    <div class="col">
        <a href="/blacklist-check" class="text-decoration-none h-100 d-block">
            <div class="card h-100 home-widget border-0 shadow-lg text-center p-2">
                <div class="widget-icon mb-1 text-primary"><i class="fa-solid fa-list-check fa-xl"></i></div>
                <div class="text-white small fw-bold">Blacklist</div>
            </div>
        </a>
    </div>

    <!-- Decode Spam -->
    <div class="col">
        <a href="/decode-spam" class="text-decoration-none h-100 d-block">
            <div class="card h-100 home-widget border-0 shadow-lg text-center p-2">
                <div class="widget-icon mb-1 text-primary"><i class="fa-solid fa-code fa-xl"></i></div>
                <div class="text-white small fw-bold">Decoder</div>
            </div>
        </a>
    </div>

    {% if config.ENABLE_WHOIS %}
    <div class="col">
        <a href="/whois" class="text-decoration-none h-100 d-block">
            <div class="card h-100 home-widget border-0 shadow-lg text-center p-2">
                <div class="widget-icon mb-1 text-primary"><i class="fa-solid fa-search fa-xl"></i></div>
                <div class="text-white small fw-bold">WHOIS</div>
            </div>
        </a>
    </div>
    {% endif %}

    {% if config.ENABLE_WEBCHECK %}
    <div class="col">
        <a href="/web-check" class="text-decoration-none h-100 d-block">
            <div class="card h-100 home-widget border-0 shadow-lg text-center p-2">
                <div class="widget-icon mb-1 text-primary"><i class="fa-solid fa-globe fa-xl"></i></div>
                <div class="text-white small fw-bold">Web Check</div>
            </div>
        </a>
    </div>
    {% endif %}

    <div class="col">
        <a href="/dashboard" class="text-decoration-none h-100 d-block">
            <div class="card h-100 home-widget border-0 shadow-lg text-center p-2">
                <div class="widget-icon mb-1 text-primary"><i class="fa-solid fa-chart-line fa-xl"></i></div>
                <div class="text-white small fw-bold">Monitor</div>
            </div>
        </a>
    </div>

    {% if session.logged_in %}
    <div class="col">
        <a href="/recipients" class="text-decoration-none h-100 d-block">
            <div class="card h-100 home-widget border-0 shadow-lg text-center p-2">
                <div class="widget-icon mb-1 text-info"><i class="fa-solid fa-users fa-xl"></i></div>
                <div class="text-white small fw-bold">Recipients</div>
            </div>
        </a>
    </div>
    {% endif %}
</div>

<!-- Pins Section -->
<div class="row mb-2">
    <div class="col-md-12 d-flex justify-content-between align-items-center">
        <h6 class="text-white fw-bold opacity-50 mb-0 text-uppercase letter-spacing-1"><i class="fa-solid fa-thumbtack me-2 text-primary"></i> Pins</h6>
        {% if session.logged_in %}
        <button class="btn btn-xs btn-outline-primary py-0" onclick="openAddModal()" style="font-size: 0.7rem;">
            <i class="fa-solid fa-plus me-1"></i> Pin
        </button>
        {% endif %}
    </div>
</div>

<div class="row row-cols-2 row-cols-md-4 row-cols-lg-6 row-cols-xl-8 g-2" id="custom-widgets-list">
    {% for widget in custom_widgets %}
    <div class="col" id="widget-col-{{ widget.id }}">
        <div class="card h-100 home-widget border-0 shadow-lg p-2 position-relative" style="background: {{ widget.color }}15 !important; border-top: 2px solid {{ widget.color }} !important;">
            {% if session.logged_in %}
            <div class="position-absolute top-0 end-0 p-1 d-flex" style="z-index: 5;">
                <button class="btn btn-link btn-xs text-muted p-0 opacity-50 me-1" onclick='openEditModal({{ widget|tojson }})'><i class="fa-solid fa-edit" style="font-size: 0.6rem;"></i></button>
                <button class="btn btn-link btn-xs text-muted p-0 opacity-50" onclick="deleteWidget({{ widget.id }})"><i class="fa-solid fa-times" style="font-size: 0.6rem;"></i></button>
            </div>
            {% endif %}
            <a href="{{ widget.url }}" target="_blank" class="text-decoration-none text-center d-block">
                <div class="widget-icon mb-1 d-flex justify-content-center align-items-center" style="height: 32px;">
                    {% if widget.image_path %}
                        <img src="{{ widget.image_path }}" class="rounded-circle border" style="width: 32px; height: 32px; object-fit: cover; border-color: {{ widget.color }} !important;">
                    {% else %}
                        <i class="fa-solid {{ widget.icon }} fa-xl" style="color: {{ widget.color }} !important;"></i>
                    {% endif %}
                </div>
                <div class="text-white small fw-bold text-truncate px-1" title="{{ widget.title }}">{{ widget.title }}</div>
                {% if widget.is_private %}<div style="font-size: 0.4rem;" class="text-warning text-uppercase fw-bold"><i class="fa-solid fa-lock me-1"></i>Private</div>{% endif %}
            </a>
        </div>
    </div>
    {% endfor %}
</div>

{% if session.logged_in %}
<!-- Add/Edit Pin Modal -->
<div class="modal fade" id="widgetModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content shadow-lg border-primary">
            <div class="modal-header">
                <h5 class="modal-title text-white" id="modalTitle">Add Pin</h5>
                <button type="button" class="btn-close shadow-none" data-bs-dismiss="modal" style="filter: hue-rotate(240deg) brightness(1.5);"></button>
            </div>
            <div class="modal-body">
                <form id="widget-form">
                    <input type="hidden" id="w-id">
                    <div class="mb-3">
                        <label class="form-label small fw-bold">Title</label>
                        <input type="text" class="form-control bg-dark border-secondary text-white" id="w-title" placeholder="My Tool" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small fw-bold">URL</label>
                        <input type="url" class="form-control bg-dark border-secondary text-white" id="w-url" placeholder="https://..." required>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label small fw-bold">Icon</label>
                            <select class="form-select bg-dark border-secondary text-white" id="w-icon">
                                <option value="fa-link">Link</option>
                                <option value="fa-server">Server</option>
                                <option value="fa-globe">Globe</option>
                                <option value="fa-shield-halved">Shield</option>
                                <option value="fa-envelope">Mail</option>
                                <option value="fa-database">Database</option>
                                <option value="fa-terminal">Terminal</option>
                                <option value="fa-chart-area">Charts</option>
                                <option value="fa-cog">Settings</option>
                                <option value="fa-search">Search</option>
                                <option value="fa-lock">Security</option>
                                <option value="fa-cloud">Cloud</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label small fw-bold">Theme Color</label>
                            <input type="color" class="form-control form-control-color bg-dark border-secondary w-100" id="w-color" value="#8a2be2">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label small fw-bold">Custom Image (Optional)</label>
                        <input type="file" class="form-control bg-dark border-secondary text-white" id="w-file" accept="image/*">
                    </div>

                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="w-private">
                        <label class="form-check-label text-white small" for="w-private">
                            <i class="fa-solid fa-eye-slash me-1"></i> Private (Admins Only)
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary px-4" id="saveBtn" onclick="saveWidget()">Save Pin</button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<style>
    .home-widget {
        transition: all 0.3s cubic-bezier(.25,.8,.25,1);
        cursor: pointer;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.05) !important;
    }
    .home-widget:hover {
        transform: translateY(-3px);
        filter: brightness(1.2);
        box-shadow: 0 8px 20px rgba(0,0,0,0.5) !important;
    }
    .widget-icon {
        transition: transform 0.3s ease;
    }
    .home-widget:hover .widget-icon {
        transform: scale(1.05);
    }

    /* Welcome Splash Styles */
    .welcome-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(15, 10, 26, 0.98);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        transition: opacity 0.8s ease-in-out, visibility 0.8s;
        backdrop-filter: blur(15px);
    }
    .welcome-overlay.hidden {
        opacity: 0;
        visibility: hidden;
    }
    .welcome-content {
        transform: translateY(30px);
        opacity: 0;
        animation: splashIn 1s cubic-bezier(0.16, 1, 0.3, 1) forwards;
    }
    @keyframes splashIn {
        to { transform: translateY(0); opacity: 1; }
    }
    .splash-logo {
        height: 120px;
        filter: drop-shadow(0 0 30px rgba(138, 43, 226, 0.8));
        animation: pulseLogo 3s infinite ease-in-out;
    }
    @keyframes pulseLogo {
        0%, 100% { transform: scale(1); filter: drop-shadow(0 0 30px rgba(138, 43, 226, 0.8)); }
        50% { transform: scale(1.05); filter: drop-shadow(0 0 50px rgba(138, 43, 226, 1)); }
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    // Splash Screen Animation
    document.addEventListener('DOMContentLoaded', () => {
        setTimeout(() => {
            const overlay = document.getElementById('welcome-overlay');
            if (overlay) overlay.classList.add('hidden');
        }, 3000);
    });

    {% if session.logged_in %}
    const widgetModal = new bootstrap.Modal(document.getElementById('widgetModal'));

    function openAddModal() {
        document.getElementById('w-id').value = '';
        document.getElementById('w-title').value = '';
        document.getElementById('w-url').value = '';
        document.getElementById('w-icon').value = 'fa-link';
        document.getElementById('w-color').value = '#8a2be2';
        document.getElementById('w-private').checked = false;
        document.getElementById('modalTitle').innerText = 'Add Pin';
        widgetModal.show();
    }

    function openEditModal(widget) {
        document.getElementById('w-id').value = widget.id;
        document.getElementById('w-title').value = widget.title;
        document.getElementById('w-url').value = widget.url;
        document.getElementById('w-icon').value = widget.icon;
        document.getElementById('w-color').value = widget.color;
        document.getElementById('w-private').checked = widget.is_private;
        document.getElementById('modalTitle').innerText = 'Edit Pin';
        widgetModal.show();
    }

    function saveWidget() {
        const id = document.getElementById('w-id').value;
        const form = new FormData();
        form.append('title', document.getElementById('w-title').value);
        form.append('url', document.getElementById('w-url').value);
        form.append('icon', document.getElementById('w-icon').value);
        form.append('color', document.getElementById('w-color').value);
        form.append('is_private', document.getElementById('w-private').checked);
        
        const fileInput = document.getElementById('w-file');
        if (fileInput.files.length > 0) {
            form.append('icon_file', fileInput.files[0]);
        }

        if (!document.getElementById('w-title').value || !document.getElementById('w-url').value) return;

        const url = id ? `/api/widgets/${id}` : '/api/widgets';
        const method = 'POST'; 
        
        if (id) {
            form.append('_method', 'PUT');
        }

        fetch(url, {
            method: method,
            body: form
        }).then(res => {
            if (res.ok) {
                location.reload();
            } else {
                showToast('Failed to save Pin.', 'Error', 'danger');
            }
        });
    }

    function deleteWidget(id) {
        if (!confirm('Delete this Pin?')) return;
        fetch(`/api/widgets/${id}`, { method: 'DELETE' })
            .then(res => {
                if (res.ok) {
                    document.getElementById(`widget-col-${id}`).remove();
                    showToast('Pin deleted.', 'Success');
                }
            });
    }
    {% endif %}
</script>
{% endblock %}