{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-lg-9 mb-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="mb-0">Live Monitor</h2>
                <small class="text-muted">Auto-refreshing every 5 seconds</small>
            </div>
        </div>

        <!-- Live Status Card -->
        <div class="card shadow-sm border-0">
            <div class="card-header fw-bold text-uppercase small text-muted">
                <i class="fa-solid fa-satellite-dish me-1"></i> Current Status
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0 align-middle table-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Recipient</th>
                                <th>Status</th>
                                <th>Sent At (UTC)</th>
                                <th>RTT <small class="text-muted">(Latency/Max)</small></th>
                                <th>SPF</th>
                                <th>DKIM</th>
                                <th>DMARC</th>
                                <th class="text-end">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="stats-body">
                            <!-- Data injected here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Sidebar Widget -->
    <div class="col-lg-3">
        <div class="sticky-top" style="top: 90px; z-index: 10;">
            <div class="card shadow-lg border-0 mb-4">
                <div class="card-header fw-bold small text-uppercase">
                    <i class="fa-solid fa-chart-pie me-2 text-primary"></i> Analytics Overview
                </div>
                <div class="card-body p-0">
                    <div id="stats-overview" class="d-grid gap-x-3 gap-y-2 py-3 px-3" style="grid-template-columns: 1fr minmax(45px, auto) minmax(45px, auto) minmax(55px, auto); white-space: nowrap;">
                        <!-- Header -->
                        <div class="small text-muted fw-bold" style="font-size: 0.6rem;">METRIC</div>
                        <div class="small text-muted fw-bold text-center" style="font-size: 0.6rem;">1H</div>
                        <div class="small text-muted fw-bold text-center" style="font-size: 0.6rem;">24H</div>
                        <div class="small text-muted fw-bold text-center" style="font-size: 0.6rem;">ALL</div>

                        <!-- Mail Sent -->
                        <div class="small fw-bold text-white-50">Mail Sent</div>
                        <div id="stat-h-sent" class="small text-center text-white fw-bold">0</div>
                        <div id="stat-d-sent" class="small text-center text-white fw-bold">0</div>
                        <div id="stat-a-sent" class="small text-center text-white fw-bold">0</div>

                        <!-- Mail Recv -->
                        <div class="small fw-bold text-white-50">Mail Recv</div>
                        <div id="stat-h-recv" class="small text-center text-success fw-bold">0</div>
                        <div id="stat-d-recv" class="small text-center text-success fw-bold">0</div>
                        <div id="stat-a-recv" class="small text-center text-success fw-bold">0</div>

                        <!-- Success Rate -->
                        <div class="small fw-bold text-white-50">Success</div>
                        <div id="stat-h-sr" class="small text-center text-info fw-bold">0%</div>
                        <div id="stat-d-sr" class="small text-center text-info fw-bold">0%</div>
                        <div id="stat-a-sr" class="small text-center text-info fw-bold">0%</div>

                        <!-- Avg RTT -->
                        <div class="small fw-bold text-white-50">Avg RTT</div>
                        <div id="stat-h-rtt" class="small text-center text-warning fw-bold">0s</div>
                        <div id="stat-d-rtt" class="small text-center text-warning fw-bold">0s</div>
                        <div class="small text-center text-muted">-</div>

                        <div class="grid-divider col-span-4 border-top border-secondary my-1 opacity-25" style="grid-column: span 4;"></div>

                        <!-- Mail Tester -->
                        <div class="small fw-bold text-white-50">Mail Tester</div>
                        <div id="stat-h-mt" class="small text-center text-primary fw-bold">0</div>
                        <div id="stat-d-mt" class="small text-center text-primary fw-bold">0</div>
                        <div id="stat-a-mt" class="small text-center text-primary fw-bold">0</div>

                        <!-- SMTP Diag -->
                        <div class="small fw-bold text-white-50">SMTP Diag</div>
                        <div id="stat-h-sd" class="small text-center text-primary fw-bold">0</div>
                        <div id="stat-d-sd" class="small text-center text-primary fw-bold">0</div>
                        <div id="stat-a-sd" class="small text-center text-primary fw-bold">0</div>

                        <!-- Blacklist -->
                        <div class="small fw-bold text-white-50">Blacklist</div>
                        <div id="stat-h-bl" class="small text-center text-primary fw-bold">0</div>
                        <div id="stat-d-bl" class="small text-center text-primary fw-bold">0</div>
                        <div id="stat-a-bl" class="small text-center text-primary fw-bold">0</div>

                        <div class="grid-divider col-span-4 border-top border-secondary my-1 opacity-25" style="grid-column: span 4;"></div>

                        <!-- Alerts -->
                        <div class="small fw-bold text-white-50">Alerts</div>
                        <div id="stat-h-al" class="small text-center text-danger fw-bold">0</div>
                        <div id="stat-d-al" class="small text-center text-danger fw-bold">0</div>
                        <div id="stat-a-al" class="small text-center text-danger fw-bold">0</div>

                        <!-- Send Failures -->
                        <div class="small fw-bold text-white-50">Failures</div>
                        <div id="stat-h-fl" class="small text-center text-danger fw-bold">0</div>
                        <div id="stat-d-fl" class="small text-center text-danger fw-bold">0</div>
                        <div id="stat-a-fl" class="small text-center text-danger fw-bold">0</div>

                        <!-- Auth Fails -->
                        <div class="small fw-bold text-white-50">SPF Fail</div>
                        <div id="stat-h-spf" class="small text-center text-warning fw-bold">0</div>
                        <div id="stat-d-spf" class="small text-center text-warning fw-bold">0</div>
                        <div id="stat-a-spf" class="small text-center text-warning fw-bold">0</div>

                        <div class="small fw-bold text-white-50">DKIM Fail</div>
                        <div id="stat-h-dkim" class="small text-center text-warning fw-bold">0</div>
                        <div id="stat-d-dkim" class="small text-center text-warning fw-bold">0</div>
                        <div id="stat-a-dkim" class="small text-center text-warning fw-bold">0</div>

                        <div class="small fw-bold text-white-50">DMARC Fail</div>
                        <div id="stat-h-dmarc" class="small text-center text-warning fw-bold">0</div>
                        <div id="stat-d-dmarc" class="small text-center text-warning fw-bold">0</div>
                        <div id="stat-a-dmarc" class="small text-center text-warning fw-bold">0</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- History Modal -->
<div class="modal fade" id="historyModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content shadow-lg border-primary">
            <div class="modal-header">
                <h5 class="modal-title text-white"><i class="fa-solid fa-clock-rotate-left me-2 text-primary"></i>History: <span id="historyRecipientTitle" class="fw-bold"></span></h5>
                <button type="button" class="btn-close shadow-none" data-bs-dismiss="modal" style="filter: hue-rotate(240deg) brightness(1.5);"></button>
            </div>
            <div class="modal-body p-0">
                <div class="table-responsive">
                    <table class="table table-sm table-striped mb-0">
                        <thead class="table-dark sticky-top">
                            <tr>
                                <th>Status</th>
                                <th>Sent At</th>
                                <th>RTT</th>
                                <th>SPF</th>
                                <th>DKIM</th>
                                <th>DMARC</th>
                                <th>GUID</th>
                            </tr>
                        </thead>
                        <tbody id="modal-history-body">
                            <!-- History Data -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-primary px-4" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    function getStatusBadge(status) {
        let color = 'secondary';
        let icon = 'fa-circle-question';
        
        if (status === 'RECEIVED') { color = 'success'; icon = 'fa-circle-check'; }
        else if (status === 'PENDING') { color = 'warning'; icon = 'fa-hourglass-half'; }
        else if (status === 'MISSING') { color = 'danger'; icon = 'fa-circle-exclamation'; }
        else if (status === 'SEND_ERROR') { color = 'dark'; icon = 'fa-circle-xmark'; }
        
        return `<span class="badge bg-${color}"><i class="fa-solid ${icon} me-1"></i>${status}</span>`;
    }

    function getAuthBadge(val) {
        if (!val || val === 'unknown') return '<span class="text-muted small">unknown</span>';
        const color = val === 'pass' ? 'success' : 'danger';
        return `<span class="badge bg-${color} font-monospace" style="font-size: 0.7em;">${val.toUpperCase()}</span>`;
    }

    function updateStats() {
        // Fetch Overview Stats
        fetch('/api/stats/overview')
            .then(res => res.json())
            .then(data => {
                const mapStats = (timeframe, prefix) => {
                    const d = data[timeframe];
                    document.getElementById(`stat-${prefix}-sent`).innerText = d.sent;
                    document.getElementById(`stat-${prefix}-recv`).innerText = d.received;
                    document.getElementById(`stat-${prefix}-sr`).innerText = d.success_rate + '%';
                    
                    if (prefix !== 'a') {
                        document.getElementById(`stat-${prefix}-rtt`).innerText = d.avg_rtt + 's';
                    }

                    document.getElementById(`stat-${prefix}-mt`).innerText = d.mail_tester;
                    document.getElementById(`stat-${prefix}-sd`).innerText = d.smtp_diag;
                    document.getElementById(`stat-${prefix}-bl`).innerText = d.blacklist;
                    
                    document.getElementById(`stat-${prefix}-al`).innerText = d.alert_sent;
                    document.getElementById(`stat-${prefix}-fl`).innerText = d.send_failure;
                    document.getElementById(`stat-${prefix}-spf`).innerText = d.spf_fail;
                    document.getElementById(`stat-${prefix}-dkim`).innerText = d.dkim_fail;
                    document.getElementById(`stat-${prefix}-dmarc`).innerText = d.dmarc_fail;
                };

                mapStats('hour', 'h');
                mapStats('day', 'd');
                mapStats('alltime', 'a');
            });

        fetch('/api/stats')
            .then(response => response.json())
            .then(data => {
                const tbody = document.getElementById('stats-body');
                tbody.innerHTML = '';
                
                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted py-4"><i class="fa-solid fa-inbox fa-2x mb-2"></i><br>No monitoring data available yet.</td></tr>';
                    return;
                }

                data.forEach(item => {
                    let rowClass = '';
                    if (item.status === 'MISSING' || item.status === 'SEND_ERROR') rowClass = 'table-danger';
                    else if (item.status === 'RECEIVED') rowClass = 'table-success';
                    else if (item.status === 'PENDING') rowClass = 'table-warning';

                    const row = `
                        <tr class="${rowClass}">
                            <td class="fw-bold">
                                ${item.recipient || '-'}
                                <div class="small text-muted font-monospace" style="font-size: 0.75em; opacity: 0.7;">${item.guid}</div>
                            </td>
                            <td>${getStatusBadge(item.status)}</td>
                            <td>${item.sent_at ? new Date(item.sent_at).toLocaleString() : '-'}</td>
                            <td>${item.latency}s <small class="text-muted">/ ${item.alert_threshold}s</small></td>
                            <td>${getAuthBadge(item.spf)}</td>
                            <td>${getAuthBadge(item.dkim)}</td>
                            <td>${getAuthBadge(item.dmarc)}</td>
                            <td class="text-end">
                                <button class="btn btn-sm btn-outline-dark" onclick="showHistory('${item.recipient}')">
                                    <i class="fa-solid fa-list"></i> History
                                </button>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            })
            .catch(err => console.error('Error fetching stats:', err));
    }

    function showHistory(recipient) {
        document.getElementById('historyRecipientTitle').innerText = recipient;
        const tbody = document.getElementById('modal-history-body');
        tbody.innerHTML = '<tr><td colspan="7" class="text-center py-3"><i class="fa-solid fa-spinner fa-spin"></i> Loading...</td></tr>';
        
        const modal = new bootstrap.Modal(document.getElementById('historyModal'));
        modal.show();

        fetch(`/api/history?recipient=${encodeURIComponent(recipient)}`)
            .then(response => response.json())
            .then(data => {
                tbody.innerHTML = '';
                if (data.length === 0) {
                     tbody.innerHTML = '<tr><td colspan="7" class="text-center py-3">No history found.</td></tr>';
                     return;
                }
                data.forEach(item => {
                    const row = `
                        <tr>
                            <td>${getStatusBadge(item.status)}</td>
                            <td class="small">${new Date(item.sent_at).toLocaleString()}</td>
                            <td>${item.latency}s <small class="text-muted">/${item.alert_threshold}s</small></td>
                            <td>${getAuthBadge(item.spf)}</td>
                            <td>${getAuthBadge(item.dkim)}</td>
                            <td>${getAuthBadge(item.dmarc)}</td>
                            <td>
                                <span class="guid-text user-select-all" style="font-size: 0.8em;">${item.guid}</span>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            });
    }

    // Initial load and periodic refresh
    updateStats();
    setInterval(updateStats, 5000);
</script>
{% endblock %}