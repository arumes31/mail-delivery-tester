version: '3.8'

services:
  db:
    image: postgres:17-alpine
    environment:
      POSTGRES_USER: ${DB_USER:-maildt}
      POSTGRES_PASSWORD: ${DB_PASS:-securepassword}
      POSTGRES_DB: ${DB_NAME:-maildt}
    volumes:
      - ./data:/var/lib/postgresql/data
    networks:
      - maildt_net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U maildt"]
      interval: 10s
      timeout: 5s
      retries: 5

  app:
    build: .
    ports:
      - "${PORT:-5000}:5000"
    depends_on:
      db:
        condition: service_healthy
    environment:
      - DB_USER=${DB_USER:-maildt}
      - DB_PASS=${DB_PASS:-securepassword}
      - DB_NAME=${DB_NAME:-maildt}
      - DB_HOST=db
      # Mail Configuration
      - SMTP_HOST=${SMTP_HOST}
      - SMTP_PORT=${SMTP_PORT:-465}
      - SMTP_USER=${SMTP_USER}
      - SMTP_PASS=${SMTP_PASS}
      - IMAP_HOST=${IMAP_HOST}
      - IMAP_PORT=${IMAP_PORT:-993}
      - IMAP_USER=${IMAP_USER}
      - IMAP_PASS=${IMAP_PASS}
      # App Logic
      - SEND_INTERVAL=${SEND_INTERVAL:-3600} # Seconds between emails
      - CHECK_INTERVAL=${CHECK_INTERVAL:-30} # Seconds between IMAP checks
      - ALERT_THRESHOLD=${ALERT_THRESHOLD:-300} # Seconds before marking as delayed
      # Alerting
      - DISCORD_WEBHOOK_URL=${DISCORD_WEBHOOK_URL}
      - ALERT_MAIL_RECIPIENT=${ALERT_MAIL_RECIPIENT} # Separate mail for alerts
      # Authentication
      - ADMIN_USER=${ADMIN_USER:-admin}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:-admin}
      - ADMIN_TOTP_SECRET=${ADMIN_TOTP_SECRET}
      # Proxy Configuration
      - ENABLE_PROXY=${ENABLE_PROXY:-true}
      # External Tools
      - ENABLE_WHOIS=${ENABLE_WHOIS:-true}
      - WHOIS_URL=${WHOIS_URL:-https://whois.reitetschlaeger.com}
      - ENABLE_WEBCHECK=${ENABLE_WEBCHECK:-true}
      - WEBCHECK_URL=${WEBCHECK_URL:-https://webcheck-512351112734521.reitetschlaeger.com/}
    volumes:
      - ./data-web:/app/data-web
    networks:
      - maildt_net
    restart: unless-stopped

networks:
  maildt_net:
